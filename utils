#!/bin/bash

log() {
	echo "[x] $1"
}

relink() {
	src="$1"
	dst="$2"

	# Validate inputs to prevent dangerous deletions
	if [[ -z "$src" ]] || [[ -z "$dst" ]]; then
		echo "Error: Source and destination paths are required"
		return 1
	fi

	# Prevent deletion of critical system paths
	if [[ "$dst" == "/" ]] || [[ "$dst" == "$HOME" ]] || [[ "$dst" == "/Users" ]] || [[ "$dst" == "/System" ]]; then
		echo "Error: Cannot relink to critical system path: $dst"
		return 1
	fi

	# Validate source exists
	if [[ ! -e "$src" ]]; then
		echo "Error: Source path does not exist: $src"
		return 1
	fi

	log "Linking $src to $dst"

	rm -rf "$dst"
	dir=$(dirname "$dst")
	[[ ! -d "$dir" ]] && mkdir -p "$dir"

	ln -s "$src" "$dst"
}

git_clone_latest_tag() {
	remote=${*: -1} # get last argument
	log "Getting list of tags from: $remote"

	tag=$(git ls-remote --tags --exit-code --refs "$remote" |
		sed -E 's/^[[:xdigit:]]+[[:space:]]+refs\/tags\/(.+)/\1/g' |
		sort --version-sort | tail -n1)

	echo "Selected tag: $tag"

	# Clone as shallowly as possible. Remote is the last argument.
	# git clone --branch "$tag" --depth 1 --shallow-submodules --recurse-submodules "$@"
}
